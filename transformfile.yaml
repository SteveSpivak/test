With(
    {
        terraformFile: "<INSERT TERRAFORM FILE TEXT>",

        // Step 1: Split into variable blocks
        variableBlocks: Filter(
            Split(terraformFile, "variable"),
            Len(ThisRecord) > 0 // Exclude empty strings
        ),

        // Step 2: Parse Each Variable Block
        parsedVariables: ForAll(
            variableBlocks,
            With(
                {
                    variableText: ThisRecord,

                    // Extract Variable Name
                    variableName: Mid(
                        variableText,
                        Find("""", variableText) + 1,
                        Find("""", Mid(variableText, Find("""", variableText) + 1)) - 1
                    ),

                    // Extract Content Block
                    contentBlockStart: Find("{", variableText),
                    contentBlockEnd: Find("}", variableText, contentBlockStart),
                    contentBlock: Mid(
                        variableText,
                        contentBlockStart + 1,
                        contentBlockEnd - contentBlockStart - 1
                    ),

                    // Extract Default Value if Present
                    defaultStart: Find("default =", variableText),
                    defaultValue: If(
                        defaultStart > 0,
                        Mid(
                            variableText,
                            defaultStart + 9,
                            Find("\n", variableText, defaultStart) - (defaultStart + 9)
                        ),
                        Blank()
                    ),

                    // Recursive Parsing Logic for Nested Types
                    parseType: If(
                        StartsWith(Trim(contentBlock), "map("),
                        "{ ""map"": """ & Trim(Mid(contentBlock, 5, Len(contentBlock) - 5)) & """ }",
                        If(
                            StartsWith(Trim(contentBlock), "list("),
                            "{ ""list"": """ & Trim(Mid(contentBlock, 6, Len(contentBlock) - 6)) & """ }",
                            If(
                                StartsWith(Trim(contentBlock), "object("),
                                "{ ""object"": """ & Trim(Mid(contentBlock, 8, Len(contentBlock) - 8)) & """ }",
                                contentBlock
                            )
                        )
                    )
                },
                // Construct JSON Object for the Variable
                "{""" & variableName & """: {" &
                    """type"": """ & parseType & """, " &
                    If(
                        !IsBlank(defaultValue),
                        """default"": """ & defaultValue & """",
                        """default"": null"""
                    ) &
                "}}"
            )
        )
    },
    // Step 3: Combine All Variables into a Single JSON Object
    "{" & Concat(parsedVariables, ThisRecord & ", ") & "}"
)
